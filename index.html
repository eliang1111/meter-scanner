<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Meter Scanner</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            text-align: center; margin: 0; background-color: #f4f4f9;
            color: #333; display: flex; justify-content: center;
            align-items: center; min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }
        .container {
            max-width: 95%; width: 480px; background: #fff;
            padding: 25px; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); margin: 20px;
            box-sizing: border-box;
        }
        h1, h2 { color: #333; margin-top: 0; margin-bottom: 20px; }
        #qr-reader { width: 100%; border-radius: 8px; overflow: hidden; border: 1px solid #eee; }
        .status-message {
            margin-top: 20px; font-weight: bold; min-height: 50px;
            display: flex; align-items: center; justify-content: center;
            flex-direction: column;
        }
        #result { color: #28a745; font-size: 1.6em; word-break: break-all; }
        button {
            color: white; padding: 15px 20px; font-size: 1.1em;
            font-weight: bold; border: none; border-radius: 8px;
            cursor: pointer; transition: background-color 0.3s, transform 0.1s;
            width: 100%; margin-top: 10px; box-sizing: border-box;
        }
        button:active { transform: scale(0.98); }
        button#startScanBtn { background-color: #007bff; }
        button#startScanBtn:hover { background-color: #0056b3; }
        button#stopScanBtn { background-color: #6c757d; margin-top: 20px; }
        button#stopScanBtn:hover { background-color: #5a6268; }

        /* CSS สำหรับ Pop-up Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); display: flex;
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 10px;
            width: 90%; max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center;
        }
        .modal-content input[type="number"] {
            width: calc(100% - 24px); padding: 12px; font-size: 1.5em;
            margin: 15px 0; border: 1px solid #ddd;
            border-radius: 4px; text-align: center;
        }
        #modalCancelLink {
            display: block;
            margin-top: 15px;
            color: #6c757d;
            font-size: 0.9em;
            text-decoration: none;
        }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body>
    <div class="container">
        <div id="mainScreen">
            <h1>Meter Scanner</h1>
            <button id="startScanBtn">กดเพื่อเริ่มสแกน</button>
        </div>
        <div id="scanScreen" style="display: none;">
            <div id="qr-reader"></div>
            <button id="stopScanBtn">ยกเลิก</button>
        </div>
    </div>

    <div id="meterModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>บันทึกค่ามิเตอร์</h2>
            <p>รหัสมิเตอร์: <strong id="modalQrData"></strong></p>
            <form id="meterForm">
                <input type="number" id="meterReadingInput" placeholder="กรอกเลขหน่วยไฟฟ้า" inputmode="numeric" pattern="[0-9]*" required>
                <button type="submit">ยืนยันข้อมูล</button>
            </form>
             <p id="modalStatus" style="font-weight: bold;"></p>
             <a href="#" id="modalCancelLink">ยกเลิก</a>
        </div>
    </div>

    <audio id="scanSound" preload="auto">
        <source src="https://github.com/tonatona/card-flip/raw/master/sound/turn.mp3" type="audio/mpeg">
    </audio>

    <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>

    <script>
        const webAppUrl = 'https://script.google.com/macros/s/AKfycbx8i2M8ulP59744o58SUAp4indrxyNibkGYj2uZaXMKMPhCP9-OMyF3lfox38CsOJYflw/exec';

        const mainScreen = document.getElementById('mainScreen');
        const scanScreen = document.getElementById('scanScreen');
        const startScanBtn = document.getElementById('startScanBtn');
        const stopScanBtn = document.getElementById('stopScanBtn');
        const qrReaderDivId = "qr-reader";
        
        const meterModal = document.getElementById('meterModal');
        const meterForm = document.getElementById('meterForm');
        const modalQrData = document.getElementById('modalQrData');
        const meterReadingInput = document.getElementById('meterReadingInput');
        const modalStatus = document.getElementById('modalStatus');
        const modalCancelLink = document.getElementById('modalCancelLink');
        const sound = document.getElementById('scanSound');

        let html5QrCode;
        let scannedQrData = null;

        function onScanSuccess(decodedText, decodedResult) {
            if (sound) {
                sound.currentTime = 0;
                sound.play();
            }
            
            html5QrCode.stop().then(() => {
                console.log(`Scan successful, data: ${decodedText}`);
                scannedQrData = decodedText;
                
                modalQrData.textContent = scannedQrData;
                meterReadingInput.value = '';
                modalStatus.textContent = '';
                meterModal.style.display = 'flex';
                meterReadingInput.focus();
            }).catch(err => {
                console.error("Failed to stop scanner after success.", err);
            });
        }

        function onScanFailure(error) { /* Do nothing */ }

        function showScreen(screenToShow) {
            mainScreen.style.display = (screenToShow === 'main') ? 'block' : 'none';
            scanScreen.style.display = (screenToShow === 'scan') ? 'block' : 'none';
        }

        function startScanner() {
            showScreen('scan');
            html5QrCode = new Html5Qrcode(qrReaderDivId);

            const formatsToSupport = [
                Html5QrcodeSupportedFormats.QR_CODE,
                Html5QrcodeSupportedFormats.CODE_128,
                Html5QrcodeSupportedFormats.CODE_39,
                Html5QrcodeSupportedFormats.EAN_13
            ];
            
            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 150 },
                formatsToSupport: formatsToSupport 
            };
            
            // === **ส่วนที่แก้ไข: กลับไปใช้การตั้งค่ากล้องแบบพื้นฐานที่ทำงานได้แน่นอน** ===
            html5QrCode.start(
                { facingMode: "environment" }, // ใช้วิธีเรียกแบบง่าย มี key แค่ 1 ตัว
                config,
                onScanSuccess,
                onScanFailure
            ).catch(err => {
                alert(`ไม่สามารถเปิดกล้องได้: ${err}`);
                showScreen('main');
            });
        }
        
        startScanBtn.addEventListener('click', () => {
             if (sound) {
                sound.load();
                sound.play().catch(e => {});
                sound.pause();
            }
            startScanner();
        });

        stopScanBtn.addEventListener('click', () => {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(err => console.error("Failed to stop scanner on cancel.", err));
            }
            showScreen('main');
        });

        meterForm.addEventListener('submit', (event) => {
            event.preventDefault(); 
            
            const meterReading = meterReadingInput.value;
            if (!meterReading) {
                alert('กรุณากรอกเลขหน่วยไฟฟ้า');
                return;
            }

            modalStatus.style.color = 'blue';
            modalStatus.textContent = 'กำลังส่งข้อมูล...';
            
            const dataToSend = {
                qrData: scannedQrData,
                meterReading: meterReading
            };

            fetch(webAppUrl, {
                method: 'POST',
                mode: 'no-cors', 
                body: JSON.stringify(dataToSend)
            })
            .then(() => {
                modalStatus.style.color = 'green';
                modalStatus.textContent = '✅ ส่งข้อมูลสำเร็จ!';
                
                setTimeout(() => {
                    meterModal.style.display = 'none';
                    startScanner(); 
                }, 500);
            })
            .catch(error => {
                modalStatus.style.color = 'red';
                modalStatus.textContent = `❌ เกิดข้อผิดพลาด`;
                 setTimeout(() => {
                    modalStatus.textContent = '';
                }, 3000);
            });
        });

        modalCancelLink.addEventListener('click', (event) => {
            event.preventDefault();
            meterModal.style.display = 'none';
            startScanner();
        });

    </script>
</body>
</html>
