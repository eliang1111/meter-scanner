<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Meter Scanner</title>
    <style>
        /* --- Universal Reset & Font --- */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            text-align: center; margin: 0; background-color: #f4f4f9;
            color: #333; display: flex; justify-content: center;
            align-items: center; min-height: 100vh;
        }

        /* --- Layout & Containers --- */
        .container {
            max-width: 95%; width: 480px; background: #fff;
            padding: 25px; border-radius: 12px;
            box-shadow: 0 4px_12px rgba(0, 0, 0, 0.1); margin: 20px;
        }
        #qr-reader-container {
            width: 100%; border-radius: 8px; overflow: hidden;
            border: 1px solid #eee; position: relative; margin-bottom: 20px;
        }

        /* --- Text & Headings --- */
        h1, h2 { color: #333; margin-top: 0; margin-bottom: 20px; }
        #modalQrData { font-weight: bold; }
        .status-message {
            font-weight: bold; min-height: 24px; margin-top: 15px;
            font-size: 1.1em;
        }

        /* --- Buttons --- */
        button {
            color: white; padding: 15px 20px; font-size: 1.1em;
            font-weight: bold; border: none; border-radius: 8px;
            cursor: pointer; transition: background-color 0.3s, transform 0.1s;
            width: 100%; margin-top: 10px;
        }
        button:active { transform: scale(0.98); }
        button:disabled { background-color: #a9a9a9; cursor: not-allowed; }

        #startScanBtn { background-color: #007bff; }
        #stopScanBtn { background-color: #6c757d; }
        #submitMeterBtn { background-color: #28a745; }

        #torch-button {
            position: absolute; top: 10px; right: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white; border: none; border-radius: 50%;
            width: 44px; height: 44px; font-size: 24px;
            cursor: pointer; z-index: 10; display: none; /* Hide by default */
        }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); display: none; /* Hide by default */
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 10px;
            width: 90%; max-width: 400px; text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-content input[type="number"] {
            width: 100%; padding: 12px; font-size: 1.5em;
            margin: 15px 0; border: 1px solid #ddd;
            border-radius: 4px; text-align: center;
        }
        .modal-cancel-link {
            display: block; margin-top: 15px; color: #6c757d;
            font-size: 0.9em; text-decoration: none; cursor: pointer;
        }

        /* --- Input Number Appearance --- */
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button {
             -webkit-appearance: none; margin: 0;
        }
        input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body>
    <div class="container">
        <div id="mainScreen">
            <h1>Meter Scanner</h1>
            <button id="startScanBtn">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô</button>
        </div>

        <div id="scanScreen" style="display: none;">
            <div id="qr-reader-container">
                <div id="qr-reader"></div>
                <button id="torch-button">üî¶</button>
            </div>
            <button id="stopScanBtn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô</button>
        </div>
    </div>

    <div id="meterModal" class="modal-overlay">
        <div class="modal-content">
            <h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå</h2>
            <p>‡∏£‡∏´‡∏±‡∏™‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå: <span id="modalQrData"></span></p>
            <form id="meterForm">
                <input type="number" id="meterReadingInput" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÑ‡∏ü‡∏ü‡πâ‡∏≤" inputmode="numeric" pattern="[0-9]*" required>
                <button type="submit" id="submitMeterBtn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </form>
            <div id="modalStatus" class="status-message"></div>
            <a class="modal-cancel-link">‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà</a>
        </div>
    </div>

    <audio id="scanSound" preload="auto" src="https://github.com/tonatona/card-flip/raw/master/sound/turn.mp3"></audio>

    <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>

    <script>
        // Wait for the DOM to be fully loaded before running the script
        document.addEventListener('DOMContentLoaded', () => {

            // --- Configuration ---
            const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx8i2M8ulP59744o58SUAp4indrxyNibkGYj2uZaXMKMPhCP9-OMyF3lfox38CsOJYflw/exec';
            const QR_READER_DIV_ID = "qr-reader";

            // --- DOM Elements ---
            const mainScreen = document.getElementById('mainScreen');
            const scanScreen = document.getElementById('scanScreen');
            const startScanBtn = document.getElementById('startScanBtn');
            const stopScanBtn = document.getElementById('stopScanBtn');
            const torchButton = document.getElementById('torch-button');

            const meterModal = document.getElementById('meterModal');
            const meterForm = document.getElementById('meterForm');
            const modalQrData = document.getElementById('modalQrData');
            const meterReadingInput = document.getElementById('meterReadingInput');
            const modalStatus = document.getElementById('modalStatus');
            const submitMeterBtn = document.getElementById('submitMeterBtn');
            const modalCancelLink = meterModal.querySelector('.modal-cancel-link');

            const scanSound = document.getElementById('scanSound');

            // --- State Variables ---
            let html5QrCode = null; // To hold the scanner instance
            let isScanning = false;  // Flag to prevent transition errors
            let isTorchOn = false;
            let scannedQrData = null;

            // --- UI/Screen Management ---
            const showScreen = (screenName) => {
                mainScreen.style.display = (screenName === 'main') ? 'block' : 'none';
                scanScreen.style.display = (screenName === 'scan') ? 'block' : 'none';
            };

            const showModal = (shouldShow) => {
                meterModal.style.display = shouldShow ? 'flex' : 'none';
            };

            // --- Scanner Logic ---
            const startScanner = () => {
                if (isScanning) {
                    console.warn("Scanner start requested, but already active.");
                    return;
                }
                isScanning = true;
                showScreen('scan');

                // Initialize the scanner instance if it doesn't exist
                if (!html5QrCode) {
                    html5QrCode = new Html5Qrcode(QR_READER_DIV_ID, {
                        formatsToSupport: [
                            Html5QrcodeSupportedFormats.QR_CODE,
                            Html5QrcodeSupportedFormats.CODE_128,
                            Html5QrcodeSupportedFormats.CODE_39,
                            Html5QrcodeSupportedFormats.EAN_13,
                        ]
                    });
                }

                const config = {
                    fps: 10,
                    qrbox: (viewportWidth, viewportHeight) => {
                        const minEdge = Math.min(viewportWidth, viewportHeight);
                        const size = Math.floor(minEdge * 0.75); // Use 75% of the smaller screen dimension
                        return { width: size, height: size };
                    },
                    rememberLastUsedCamera: true, // Improves user experience on repeated use
                    supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
                };

                html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                    .then(() => {
                        // Check for torch capabilities after the camera has started
                        checkTorchCapability();
                    })
                    .catch(err => {
                        isScanning = false;
                        alert(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ${err}`);
                        showScreen('main');
                    });
            };

            const stopScanner = () => {
                if (html5QrCode && html5QrCode.isScanning) {
                    return html5QrCode.stop()
                        .then(() => {
                            isScanning = false;
                            torchButton.style.display = 'none';
                            console.log("Scanner stopped successfully.");
                        })
                        .catch(err => {
                            isScanning = false;
                            console.error("Failed to stop scanner.", err);
                        });
                }
                return Promise.resolve();
            };

            const onScanSuccess = (decodedText, decodedResult) => {
                scanSound.play().catch(e => console.log("Sound play failed."));

                // Stop the scanner and then show the modal
                stopScanner().then(() => {
                    scannedQrData = decodedText;
                    modalQrData.textContent = scannedQrData;
                    meterReadingInput.value = '';
                    modalStatus.textContent = '';
                    submitMeterBtn.disabled = false;
                    showModal(true);
                    meterReadingInput.focus();
                });
            };

            const onScanFailure = (error) => {
                // This is called frequently. It's best to ignore it.
            };

            const checkTorchCapability = () => {
                try {
                    const capabilities = html5QrCode.getRunningTrackCameraCapabilities();
                    if (capabilities.torch) {
                        torchButton.style.display = 'block';
                    }
                } catch (e) {
                    console.warn("Could not get camera capabilities for torch.", e);
                }
            };

            // --- Event Listeners ---
            startScanBtn.addEventListener('click', startScanner);

            stopScanBtn.addEventListener('click', () => {
                stopScanner().then(() => showScreen('main'));
            });

            torchButton.addEventListener('click', () => {
                if (html5QrCode && html5QrCode.isScanning) {
                    isTorchOn = !isTorchOn;
                    html5QrCode.applyVideoConstraints({ advanced: [{ torch: isTorchOn }] });
                }
            });

            meterForm.addEventListener('submit', (event) => {
                event.preventDefault();
                const meterReading = meterReadingInput.value;
                if (!meterReading) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÑ‡∏ü‡∏ü‡πâ‡∏≤');
                    return;
                }

                // Disable button to prevent multiple submissions
                submitMeterBtn.disabled = true;
                modalStatus.style.color = 'blue';
                modalStatus.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';

                const dataToSend = { qrData: scannedQrData, meterReading: meterReading, timestamp: new Date().toISOString() };

                // "Fire-and-forget" request due to no-cors mode limitations
                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSend),
                    redirect: 'follow'
                });

                // Since we can't confirm success with 'no-cors', we assume it was sent.
                modalStatus.style.color = 'green';
                modalStatus.textContent = '‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß';

                // Close modal and restart scanner after a short delay
                setTimeout(() => {
                    showModal(false);
                    startScanner();
                }, 1000);
            });

            modalCancelLink.addEventListener('click', (event) => {
                event.preventDefault();
                showModal(false);
                startScanner(); // Go back to scanning
            });

        });
    </script>
</body>
</html>