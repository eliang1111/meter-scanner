<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Meter Scanner</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            text-align: center; margin: 0; background-color: #f4f4f9;
            color: #333; display: flex; justify-content: center;
            align-items: center; min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }
        .container {
            max-width: 95%; width: 480px; background: #fff;
            padding: 25px; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); margin: 20px;
            box-sizing: border-box;
        }
        h1, h2 { color: #333; margin-top: 0; margin-bottom: 20px; }
        #qr-reader { width: 100%; border-radius: 8px; overflow: hidden; border: 1px solid #eee; }
        .status-message {
            margin-top: 20px; font-weight: bold; min-height: 50px;
            display: flex; align-items: center; justify-content: center;
            flex-direction: column;
        }
        #result { color: #28a745; font-size: 1.6em; word-break: break-all; }
        button {
            color: white; padding: 15px 20px; font-size: 1.1em;
            font-weight: bold; border: none; border-radius: 8px;
            cursor: pointer; transition: background-color 0.3s, transform 0.1s;
            width: 100%; margin-top: 10px; box-sizing: border-box;
        }
        button:active { transform: scale(0.98); }
        button#startScanBtn { background-color: #007bff; }
        button#startScanBtn:hover { background-color: #0056b3; }
        button#stopScanBtn { background-color: #6c757d; margin-top: 20px; }
        button#stopScanBtn:hover { background-color: #5a6268; }
        button#focusBtn { background-color: #ffc107; margin-top: 10px; }
        button#focusBtn:hover { background-color: #e0a800; }

        /* CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Pop-up Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); display: flex;
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 10px;
            width: 90%; max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center;
        }
        .modal-content input[type="number"] {
            width: calc(100% - 24px); padding: 12px; font-size: 1.5em;
            margin: 15px 0; border: 1px solid #ddd;
            border-radius: 4px; text-align: center;
        }
        #modalCancelLink {
            display: block;
            margin-top: 15px;
            color: #6c757d;
            font-size: 0.9em;
            text-decoration: none;
        }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        .scan-controls {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        .scan-controls button {
            flex: 1;
            margin-top: 0;
        }
        
        .focus-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.9em;
            background-color: #e9ecef;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="mainScreen">
            <h1>Meter Scanner</h1>
            <button id="startScanBtn">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô</button>
        </div>
        <div id="scanScreen" style="display: none;">
            <div id="qr-reader"></div>
            <div class="scan-controls">
                <button id="focusBtn">üì∑ ‡πÇ‡∏ü‡∏Å‡∏±‡∏™</button>
                <button id="stopScanBtn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
            <div id="focusStatus" class="focus-status">
                ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏°‡∏ä‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á
            </div>
        </div>
    </div>

    <div id="meterModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå</h2>
            <p>‡∏£‡∏´‡∏±‡∏™‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå: <strong id="modalQrData"></strong></p>
            <form id="meterForm">
                <input type="number" id="meterReadingInput" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÑ‡∏ü‡∏ü‡πâ‡∏≤" inputmode="numeric" pattern="[0-9]*" required>
                <button type="submit">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </form>
             <p id="modalStatus" style="font-weight: bold;"></p>
             <a href="#" id="modalCancelLink">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</a>
        </div>
    </div>

    <audio id="scanSound" preload="auto">
        <source src="https://github.com/tonatona/card-flip/raw/master/sound/turn.mp3" type="audio/mpeg">
    </audio>

    <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>

    <script>
        const webAppUrl = 'https://script.google.com/macros/s/AKfycbx8i2M8ulP59744o58SUAp4indrxyNibkGYj2uZaXMKMPhCP9-OMyF3lfox38CsOJYflw/exec';

        const mainScreen = document.getElementById('mainScreen');
        const scanScreen = document.getElementById('scanScreen');
        const startScanBtn = document.getElementById('startScanBtn');
        const stopScanBtn = document.getElementById('stopScanBtn');
        const focusBtn = document.getElementById('focusBtn');
        const focusStatus = document.getElementById('focusStatus');
        const qrReaderDivId = "qr-reader";
        
        const meterModal = document.getElementById('meterModal');
        const meterForm = document.getElementById('meterForm');
        const modalQrData = document.getElementById('modalQrData');
        const meterReadingInput = document.getElementById('meterReadingInput');
        const modalStatus = document.getElementById('modalStatus');
        const modalCancelLink = document.getElementById('modalCancelLink');
        const sound = document.getElementById('scanSound');

        let html5QrCode;
        let scannedQrData = null;
        let currentStream = null;

        function onScanSuccess(decodedText, decodedResult) {
            if (sound) {
                sound.currentTime = 0;
                sound.play();
            }
            
            html5QrCode.stop().then(() => {
                console.log(`Scan successful, data: ${decodedText}`);
                scannedQrData = decodedText;
                
                modalQrData.textContent = scannedQrData;
                meterReadingInput.value = '';
                modalStatus.textContent = '';
                meterModal.style.display = 'flex';
                meterReadingInput.focus();
            }).catch(err => {
                console.error("Failed to stop scanner after success.", err);
            });
        }

        function onScanFailure(error) { /* Do nothing */ }

        function showScreen(screenToShow) {
            mainScreen.style.display = (screenToShow === 'main') ? 'block' : 'none';
            scanScreen.style.display = (screenToShow === 'scan') ? 'block' : 'none';
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÇ‡∏ü‡∏Å‡∏±‡∏™
        async function triggerFocus() {
            try {
                if (currentStream) {
                    const videoTrack = currentStream.getVideoTracks()[0];
                    if (videoTrack) {
                        const capabilities = videoTrack.getCapabilities();
                        
                        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ focus mode ‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                        if (capabilities.focusMode && capabilities.focusMode.includes('continuous')) {
                            await videoTrack.applyConstraints({
                                advanced: [{
                                    focusMode: 'continuous',
                                    focusDistance: 0.1 // ‡∏£‡∏∞‡∏¢‡∏∞‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö barcode
                                }]
                            });
                            focusStatus.textContent = "‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß";
                            focusStatus.style.backgroundColor = "#d4edda";
                            focusStatus.style.color = "#155724";
                        } else if (capabilities.focusMode && capabilities.focusMode.includes('manual')) {
                            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ continuous ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ manual focus
                            await videoTrack.applyConstraints({
                                advanced: [{
                                    focusMode: 'manual',
                                    focusDistance: 0.1
                                }]
                            });
                            focusStatus.textContent = "‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡πÅ‡∏ö‡∏ö manual ‡πÅ‡∏•‡πâ‡∏ß";
                            focusStatus.style.backgroundColor = "#d4edda";
                            focusStatus.style.color = "#155724";
                        } else {
                            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ focus ‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö zoom ‡πÅ‡∏ó‡∏ô
                            if (capabilities.zoom) {
                                await videoTrack.applyConstraints({
                                    advanced: [{
                                        zoom: Math.min(capabilities.zoom.max, 2.0)
                                    }]
                                });
                                focusStatus.textContent = "‚úÖ ‡∏õ‡∏£‡∏±‡∏ö zoom ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô";
                                focusStatus.style.backgroundColor = "#d1ecf1";
                                focusStatus.style.color = "#0c5460";
                            } else {
                                focusStatus.textContent = "‚ùå ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÇ‡∏ü‡∏Å‡∏±‡∏™";
                                focusStatus.style.backgroundColor = "#f8d7da";
                                focusStatus.style.color = "#721c24";
                            }
                        }
                    }
                }
            } catch (error) {
                console.error("Focus error:", error);
                focusStatus.textContent = "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡πÑ‡∏î‡πâ";
                focusStatus.style.backgroundColor = "#fff3cd";
                focusStatus.style.color = "#856404";
            }
        }

        async function startScanner() {
            showScreen('scan');
            html5QrCode = new Html5Qrcode(qrReaderDivId);

            const formatsToSupport = [
                Html5QrcodeSupportedFormats.QR_CODE,
                Html5QrcodeSupportedFormats.CODE_128,
                Html5QrcodeSupportedFormats.CODE_39,
                Html5QrcodeSupportedFormats.EAN_13
            ];
            
            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 150 },
                formatsToSupport: formatsToSupport 
            };
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ constraints ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö auto focus
            const cameraConstraints = {
                facingMode: "environment",
                advanced: [
                    {
                        focusMode: "continuous",
                        focusDistance: 0.1
                    }
                ]
            };
            
            try {
                await html5QrCode.start(
                    cameraConstraints,
                    config,
                    onScanSuccess,
                    onScanFailure
                );
                
                // ‡πÄ‡∏Å‡πá‡∏ö stream reference ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÇ‡∏ü‡∏Å‡∏±‡∏™
                setTimeout(async () => {
                    try {
                        currentStream = await navigator.mediaDevices.getUserMedia({
                            video: cameraConstraints
                        });
                        focusStatus.textContent = "üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô - ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏°‡∏ä‡∏±‡∏î";
                        focusStatus.style.backgroundColor = "#e9ecef";
                        focusStatus.style.color = "#6c757d";
                    } catch (e) {
                        console.error("Stream access error:", e);
                    }
                }, 1000);
                
            } catch (err) {
                console.error("Scanner start error:", err);
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ advanced constraints ‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢
                try {
                    await html5QrCode.start(
                        { facingMode: "environment" },
                        config,
                        onScanSuccess,
                        onScanFailure
                    );
                    focusStatus.textContent = "üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡πÇ‡∏´‡∏°‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô)";
                    focusStatus.style.backgroundColor = "#fff3cd";
                    focusStatus.style.color = "#856404";
                } catch (basicErr) {
                    alert(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ${basicErr}`);
                    showScreen('main');
                }
            }
        }
        
        startScanBtn.addEventListener('click', () => {
             if (sound) {
                sound.load();
                sound.play().catch(e => {});
                sound.pause();
            }
            startScanner();
        });

        stopScanBtn.addEventListener('click', () => {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(err => console.error("Failed to stop scanner on cancel.", err));
            }
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            showScreen('main');
        });

        focusBtn.addEventListener('click', triggerFocus);

        meterForm.addEventListener('submit', (event) => {
            event.preventDefault(); 
            
            const meterReading = meterReadingInput.value;
            if (!meterReading) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÑ‡∏ü‡∏ü‡πâ‡∏≤');
                return;
            }

            modalStatus.style.color = 'blue';
            modalStatus.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
            
            const dataToSend = {
                qrData: scannedQrData,
                meterReading: meterReading
            };

            fetch(webAppUrl, {
                method: 'POST',
                mode: 'no-cors', 
                body: JSON.stringify(dataToSend)
            })
            .then(() => {
                modalStatus.style.color = 'green';
                modalStatus.textContent = '‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
                
                setTimeout(() => {
                    meterModal.style.display = 'none';
                    startScanner(); 
                }, 500);
            })
            .catch(error => {
                modalStatus.style.color = 'red';
                modalStatus.textContent = `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î`;
                 setTimeout(() => {
                    modalStatus.textContent = '';
                }, 3000);
            });
        });

        modalCancelLink.addEventListener('click', (event) => {
            event.preventDefault();
            meterModal.style.display = 'none';
            startScanner();
        });

    </script>
</body>
</html>